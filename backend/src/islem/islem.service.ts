import { Injectable } from '@nestjs/common';
import { InjectDataSource } from '@nestjs/typeorm';
import { DataSource } from 'typeorm';
import { DatabaseConfigService } from '../database/database-config.service';

// Types for stronger typing and to avoid any-unsafe lint warnings
type KasaGunlukOzet = { tarih: string; gelir: number; gider: number };
type DetayIslem = {
  id: number;
  iKytTarihi: string;
  islemAltG: string;
  islemGrup: string;
  islemTutar: number;
  islemBilgi: string;
};
type KasaDevirKaydi = {
  DevirTarihi: string;
  DevirEden: string;
  KasaYekun: number;
};

@Injectable()
export class IslemService {
  constructor(
    @InjectDataSource()
    private readonly dataSource: DataSource,
    private readonly dbConfig: DatabaseConfigService,
  ) {}

  private debugLog(...args: unknown[]): void {
    if (process.env.NODE_ENV !== 'production') {
      console.log(...args);
    }
  }

  /**
   * Kasa i≈ülemleri i√ßin g√ºnl√ºk toplamlarƒ± getirir
   */
  async getKasaIslemleri(
    islemTuru: string,
    islemYonu?: string,
    page: number = 1,
    rowsPerPage: number = 15,
  ): Promise<{ data: KasaGunlukOzet[]; totalRecords: number }> {
    try {
      const schemaName = this.dbConfig.getTableSchema();
      const tableName = this.dbConfig.getTableName('tblislem');

      // Tarih aralƒ±ƒüƒ± (son 1 yƒ±l)
      const bugun = new Date();
      const birYilOnce = new Date();
      birYilOnce.setFullYear(birYilOnce.getFullYear() - 1);

      // DD.MM.YYYY formatƒ±na √ßevir
      const baslangicTarihi =
        birYilOnce.getDate().toString().padStart(2, '0') +
        '.' +
        (birYilOnce.getMonth() + 1).toString().padStart(2, '0') +
        '.' +
        birYilOnce.getFullYear();
      const bitisTarihi =
        bugun.getDate().toString().padStart(2, '0') +
        '.' +
        (bugun.getMonth() + 1).toString().padStart(2, '0') +
        '.' +
        bugun.getFullYear();

      this.debugLog('üîç Debug bilgileri:');
      this.debugLog('- Schema:', schemaName);
      this.debugLog('- Tablo:', tableName);
      this.debugLog('- ƒ∞≈ülem t√ºr√º:', islemTuru);
      this.debugLog('- ƒ∞≈ülem y√∂n√º:', islemYonu);
      this.debugLog('- Tarih aralƒ±ƒüƒ±:', baslangicTarihi, 'ile', bitisTarihi);

      // Gereksiz aƒüƒ±r debug sorgularƒ± kaldƒ±rƒ±ldƒ±

      let whereCondition = '';
      let params: any[] = [];

      // ƒ∞≈ülem t√ºr√ºne g√∂re filtreleme
      switch (islemTuru) {
        case 'cari':
          whereCondition = `WHERE i.islemArac = 'Cari ƒ∞≈ülem'`;
          break;
        case 'nakit':
          whereCondition = `WHERE i.islemArac = 'Nakit Kasa(TL)'`;
          break;
        case 'kart':
          whereCondition = `WHERE i.islemArac = 'Kredi Kartlarƒ±'`;
          break;
        case 'eft':
          whereCondition = `WHERE i.islemArac = 'Banka EFT'`;
          break;
        case 'acenta':
          whereCondition = `WHERE i.islemArac = 'Acenta Tahsilat'`;
          break;
        case 'depozito':
          whereCondition = `WHERE (i.islemBilgi LIKE '%=DEPOZƒ∞TO TAHSƒ∞LATI=%' OR i.islemBilgi LIKE '%=DEPOZƒ∞TO ƒ∞ADESƒ∞=%')`;
          break;
        default:
          whereCondition = `WHERE i.islemArac = 'Cari ƒ∞≈ülem'`;
      }

      // ƒ∞≈ülem y√∂n√ºne g√∂re dinamik sorgu
      let gelirCondition = '';
      let giderCondition = '';

      if (islemYonu === 'gelir-gider') {
        // Cari se√ßildiƒüinde GELƒ∞R/Gƒ∞DER
        gelirCondition = "i.islemTip = 'GELƒ∞R'";
        giderCondition = "i.islemTip = 'Gƒ∞DER'";
      } else {
        // Diƒüer se√ßimlerde Giren/√áƒ±kan
        gelirCondition = "i.islemTip = 'Giren'";
        giderCondition = "i.islemTip = '√áƒ±kan'";
      }

      // √ñnce toplam kayƒ±t sayƒ±sƒ±nƒ± al
      const countQuery = `
          SELECT COUNT(*) as total
          FROM (
            SELECT i.iKytTarihi
            FROM ${schemaName}.${tableName} i
            ${whereCondition}
            AND CONVERT(DATE, i.iKytTarihi, 104) >= CONVERT(DATE, @0, 104)
            AND CONVERT(DATE, i.iKytTarihi, 104) <= CONVERT(DATE, @1, 104)
            GROUP BY i.iKytTarihi
          ) as grouped_data
        `;

      const countResultUnknown = (await this.dataSource.query(countQuery, [
        baslangicTarihi,
        bitisTarihi,
      ])) as unknown;
      const countResult = countResultUnknown as Array<{ total: number }>;
      const totalRecords = Number(countResult[0]?.total || 0);
      this.debugLog('üîç Count Query sonucu:', countResult);
      this.debugLog('üîç Toplam kayƒ±t sayƒ±sƒ±:', totalRecords);

      // Pagination i√ßin OFFSET hesapla
      const offset = (page - 1) * rowsPerPage;

      const query = `
          SELECT 
            i.iKytTarihi as tarih,
            SUM(CASE WHEN ${gelirCondition} THEN i.islemTutar ELSE 0 END) as gelir,
            SUM(CASE WHEN ${giderCondition} THEN i.islemTutar ELSE 0 END) as gider
          FROM ${schemaName}.${tableName} i
          ${whereCondition}
          AND CONVERT(DATE, i.iKytTarihi, 104) >= CONVERT(DATE, @0, 104)
          AND CONVERT(DATE, i.iKytTarihi, 104) <= CONVERT(DATE, @1, 104)
          GROUP BY i.iKytTarihi
          ORDER BY CONVERT(DATE, i.iKytTarihi, 104) DESC
          OFFSET @2 ROWS
          FETCH NEXT @3 ROWS ONLY
        `;

      params = [baslangicTarihi, bitisTarihi, offset, rowsPerPage];

      this.debugLog('üîç SQL Sorgusu:', query);
      this.debugLog('üîç Parametreler:', params);

      const resultUnknown = (await this.dataSource.query(
        query,
        params,
      )) as unknown;
      const result = resultUnknown as Array<{
        tarih: string;
        gelir: number | string | null;
        gider: number | string | null;
      }>;

      // Sadece 3 s√ºtun d√∂nd√ºr (bakiye hesaplama kaldƒ±rƒ±ldƒ±)
      const processedData: KasaGunlukOzet[] = result.map((row) => ({
        tarih: row.tarih,
        gelir: Number(row.gelir) || 0,
        gider: Number(row.gider) || 0,
      }));

      return {
        data: processedData,
        totalRecords: totalRecords,
      };
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('Kasa i≈ülemleri getirme hatasƒ±:', message);
      throw new Error('Kasa i≈ülemleri getirilemedi');
    }
  }

  /**
   * Kasa devri kaydƒ± ekler (tblKasaDevir)
   */
  async saveKasaDevir(kasaYekun: number): Promise<{ success: boolean }> {
    try {
      if (!Number.isFinite(kasaYekun)) {
        throw new Error('Ge√ßersiz kasa tutarƒ±');
      }
      const kasaYekunFixed = Number(parseFloat(String(kasaYekun)).toFixed(2));
      // Tarihi DD.MM.YYYY formatƒ±nda hazƒ±rla (nchar(10))
      const bugun = new Date();
      const nKytTarihi =
        bugun.getDate().toString().padStart(2, '0') +
        '.' +
        (bugun.getMonth() + 1).toString().padStart(2, '0') +
        '.' +
        bugun.getFullYear();

      // Aktif kullanƒ±cƒ± adƒ± (tblPersonel.PrsnUsrNm)
      const aktifKullanici = await this.getAktifKullaniciAdi();

      // Daima INSERT
      // nKasaNo kimliƒüi (tablo IDENTITY deƒüil; bu y√ºzden yeni deƒüer √ºret)
      const nextIdQuery = `
        SELECT ISNULL(MAX(nKasaNo), 0) + 1 AS nextId
        FROM ${this.dbConfig.getTableSchema()}.tblKasaDevir WITH (TABLOCKX)
      `;
      const nextIdResUnknown = (await this.dataSource.query(
        nextIdQuery,
      )) as unknown;
      const nextIdRes = nextIdResUnknown as Array<{ nextId: number | string }>;
      const nextId = parseInt(String(nextIdRes?.[0]?.nextId ?? 1), 10);

      const insertQuery = `
        INSERT INTO ${this.dbConfig.getTableSchema()}.tblKasaDevir (nKasaNo, nKytTarihi, nKasaDvrAln, nKasaYekun)
        VALUES (@0, @1, @2, @3)
      `;
      const params = [nextId, nKytTarihi, aktifKullanici, kasaYekunFixed];
      this.debugLog('üìù KasaDevir INSERT sorgusu:', insertQuery);
      this.debugLog('üìù Parametreler:', params);
      await this.dataSource.query(insertQuery, params);

      return { success: true };
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('‚ùå Kasa devir kaydƒ± ekleme hatasƒ±:', message);
      throw new Error(`Kasa devir kaydƒ± eklenemedi: ${message}`);
    }
  }

  /**
   * Detay i≈ülemleri getirir
   */
  async getDetayIslemler(
    tarih: string,
    islemTuru: string,
    islemYonu: string,
    selectedYonu?: string,
    page: number = 1,
    rowsPerPage: number = 15,
  ): Promise<{ data: DetayIslem[]; totalRecords: number }> {
    try {
      const schemaName = this.dbConfig.getTableSchema();
      const tableName = this.dbConfig.getTableName('tblislem');

      this.debugLog('üîç Detay i≈ülemler debug bilgileri:');
      this.debugLog('- Schema:', schemaName);
      this.debugLog('- Tablo:', tableName);
      this.debugLog('- Tarih:', tarih);
      this.debugLog('- ƒ∞≈ülem t√ºr√º:', islemTuru);
      this.debugLog('- ƒ∞≈ülem y√∂n√º:', islemYonu);
      this.debugLog('- Se√ßilen y√∂n:', selectedYonu);

      // ƒ∞≈ülem t√ºr√ºne g√∂re islemArac filtresi
      let islemAracFilter = '';
      switch (islemTuru) {
        case 'cari':
          islemAracFilter = "i.islemArac = 'Cari ƒ∞≈ülem'";
          break;
        case 'nakit':
          islemAracFilter = "i.islemArac = 'Nakit Kasa(TL)'";
          break;
        case 'kart':
          islemAracFilter = "i.islemArac = 'Kredi Kartlarƒ±'";
          break;
        case 'eft':
          islemAracFilter = "i.islemArac = 'Banka EFT'";
          break;
        case 'acenta':
          islemAracFilter = "i.islemArac = 'Acenta Tahsilat'";
          break;
        case 'depozito':
          islemAracFilter =
            "(i.islemBilgi LIKE '%=DEPOZƒ∞TO TAHSƒ∞LATI=%' OR i.islemBilgi LIKE '%=DEPOZƒ∞TO ƒ∞ADESƒ∞=%')";
          break;
        default:
          islemAracFilter = "i.islemArac = 'Cari ƒ∞≈ülem'";
      }

      // ƒ∞≈ülem y√∂n√ºne g√∂re islemTip filtresi
      let islemTipFilter = '';
      if (islemYonu === 'gelir-gider') {
        // Cari se√ßildiƒüinde GELƒ∞R/Gƒ∞DER
        islemTipFilter =
          selectedYonu === 'gelir'
            ? "i.islemTip = 'GELƒ∞R'"
            : "i.islemTip = 'Gƒ∞DER'";
      } else {
        // Diƒüer se√ßimlerde Giren/√áƒ±kan
        islemTipFilter =
          selectedYonu === 'gelir'
            ? "i.islemTip = 'Giren'"
            : "i.islemTip = '√áƒ±kan'";
      }

      this.debugLog('üîç islemTipFilter:', islemTipFilter);

      // √ñnce toplam kayƒ±t sayƒ±sƒ±nƒ± al
      const countQuery = `
        SELECT COUNT(*) as total
        FROM ${schemaName}.${tableName} i
        WHERE ${islemAracFilter}
        AND ${islemTipFilter}
        AND i.iKytTarihi = @0
      `;

      const countDetayUnknown = (await this.dataSource.query(countQuery, [
        tarih,
      ])) as unknown;
      const countDetay = countDetayUnknown as Array<{ total: number }>;
      const totalRecords = Number(countDetay[0]?.total || 0);
      this.debugLog('üîç Detay Count Query sonucu:', countResult);
      this.debugLog('üîç Detay toplam kayƒ±t sayƒ±sƒ±:', totalRecords);

      // Pagination i√ßin OFFSET hesapla
      const offset = (page - 1) * rowsPerPage;

      const query = `
        SELECT 
          ROW_NUMBER() OVER (ORDER BY i.islemAltG ASC, i.islemTutar DESC) as id,
          i.iKytTarihi,
          i.islemAltG,
          i.islemGrup,
          i.islemTutar,
          i.islemBilgi
        FROM ${schemaName}.${tableName} i
        WHERE ${islemAracFilter}
        AND ${islemTipFilter}
        AND i.iKytTarihi = @0
        ORDER BY i.islemAltG ASC, i.islemTutar DESC
        OFFSET @1 ROWS
        FETCH NEXT @2 ROWS ONLY
      `;

      this.debugLog('üîç Detay SQL Sorgusu:', query);
      this.debugLog('üîç Parametreler:', [tarih, offset, rowsPerPage]);

      const resultUnknown2 = (await this.dataSource.query(query, [
        tarih,
        offset,
        rowsPerPage,
      ])) as unknown;
      const result = resultUnknown2 as Array<{
        id: number | string;
        iKytTarihi: string;
        islemAltG: string;
        islemGrup: string;
        islemTutar: number | string;
        islemBilgi: string;
      }>;
      this.debugLog('üìä Detay i≈ülemler sonucu:', result);

      const typed: DetayIslem[] = (
        result as Array<{
          id: number;
          iKytTarihi: string;
          islemAltG: string;
          islemGrup: string;
          islemTutar: number | string;
          islemBilgi: string;
        }>
      ).map((row) => ({
        id: Number(row.id),
        iKytTarihi: row.iKytTarihi,
        islemAltG: row.islemAltG,
        islemGrup: row.islemGrup,
        islemTutar: Number(row.islemTutar) || 0,
        islemBilgi: row.islemBilgi,
      }));

      return {
        data: typed,
        totalRecords: totalRecords,
      };
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('Detay i≈ülemler getirme hatasƒ±:', message);
      throw new Error('Detay i≈ülemler getirilemedi');
    }
  }

  /**
   * Depozito i≈ülemleri i√ßin √∂zel filtreleme
   */
  async getDepozitoIslemleri(): Promise<any[]> {
    try {
      const schemaName = this.dbConfig.getTableSchema();
      const tableName = this.dbConfig.getTableName('tblislem');

      // Tarih aralƒ±ƒüƒ± (son 1 yƒ±l) - DD.MM.YYYY formatƒ±nda
      const bugun = new Date();
      const birYilOnce = new Date();
      birYilOnce.setFullYear(birYilOnce.getFullYear() - 1);

      // DD.MM.YYYY formatƒ±na √ßevir
      const baslangicTarihi =
        birYilOnce.getDate().toString().padStart(2, '0') +
        '.' +
        (birYilOnce.getMonth() + 1).toString().padStart(2, '0') +
        '.' +
        birYilOnce.getFullYear();
      const bitisTarihi =
        bugun.getDate().toString().padStart(2, '0') +
        '.' +
        (bugun.getMonth() + 1).toString().padStart(2, '0') +
        '.' +
        bugun.getFullYear();

      const query = `
         SELECT 
           i.iKytTarihi as tarih,
           SUM(CASE WHEN i.islemBilgi LIKE '%=DEPOZƒ∞TO TAHSƒ∞LATI=%' THEN i.islemTutar ELSE 0 END) as gelir,
           SUM(CASE WHEN i.islemBilgi LIKE '%=DEPOZƒ∞TO ƒ∞ADESƒ∞=%' THEN i.islemTutar ELSE 0 END) as gider
         FROM ${schemaName}.${tableName} i
         WHERE (i.islemBilgi LIKE '%=DEPOZƒ∞TO TAHSƒ∞LATI=%' OR i.islemBilgi LIKE '%=DEPOZƒ∞TO ƒ∞ADESƒ∞=%')
         AND CONVERT(DATE, i.iKytTarihi, 104) >= CONVERT(DATE, @0, 104)
         AND CONVERT(DATE, i.iKytTarihi, 104) <= CONVERT(DATE, @1, 104)
         GROUP BY i.iKytTarihi
         ORDER BY CONVERT(DATE, i.iKytTarihi, 104) DESC
       `;

      const depoUnknown = (await this.dataSource.query(query, [
        baslangicTarihi,
        bitisTarihi,
      ])) as unknown;
      const result = depoUnknown as Array<{
        tarih: string;
        gelir: number | string | null;
        gider: number | string | null;
      }>;

      // Bakiye hesaplama
      const baslangicBakiye = 107695; // Depozito ba≈ülangƒ±√ß bakiyesi
      let currentBakiye = baslangicBakiye;

      const processedData = result.map((row) => {
        const gelir = Number(row.gelir) || 0;
        const gider = Number(row.gider) || 0;

        currentBakiye = currentBakiye + gelir - gider;

        return {
          tarih: row.tarih,
          gelir: gelir,
          gider: gider,
          bakiye: currentBakiye,
        };
      });

      return processedData;
    } catch (error) {
      console.error('Depozito i≈ülemleri getirme hatasƒ±:', error);
      throw new Error('Depozito i≈ülemleri getirilemedi');
    }
  }

  /**
   * ƒ∞≈ülem kayƒ±tlarƒ±nƒ± kaydetmek i√ßin (eski metod - backward compatibility)
   */
  async kaydetIslemler(kayitlar: any[]): Promise<any[]> {
    try {
      this.debugLog(`${kayitlar.length} kayƒ±t kaydediliyor...`);

      // ≈ûimdilik basit bir mock response d√∂nd√ºr√ºyoruz
      // Ger√ßek implementasyon i√ßin stored procedure kullanƒ±labilir
      const sonuclar = kayitlar.map((kayit, index) => ({
        id: index + 1,
        success: true,
        message: `Kayƒ±t ${index + 1} ba≈üarƒ±yla kaydedildi`,
      }));

      this.debugLog(`${kayitlar.length} kayƒ±t ba≈üarƒ±yla kaydedildi`);
      return sonuclar;
    } catch (error) {
      console.error('ƒ∞≈ülem kaydetme hatasƒ±:', error);
      throw new Error('ƒ∞≈ülem kayƒ±tlarƒ± kaydedilemedi');
    }
  }

  /**
   * G√ºncel bakiye hesaplar (t√ºm g√ºnlerin toplamƒ±)
   */
  async getGuncelBakiye(
    islemTuru: string,
    islemYonu?: string,
  ): Promise<number> {
    try {
      const schemaName = this.dbConfig.getTableSchema();
      const tableName = this.dbConfig.getTableName('tblislem');

      let whereCondition = '';

      // ƒ∞≈ülem t√ºr√ºne g√∂re filtreleme
      switch (islemTuru) {
        case 'cari':
          whereCondition = `WHERE i.islemArac = 'Cari ƒ∞≈ülem'`;
          break;
        case 'nakit':
          whereCondition = `WHERE i.islemArac = 'Nakit Kasa(TL)'`;
          break;
        case 'kart':
          whereCondition = `WHERE i.islemArac = 'Kredi Kartlarƒ±'`;
          break;
        case 'eft':
          whereCondition = `WHERE i.islemArac = 'Banka EFT'`;
          break;
        case 'acenta':
          whereCondition = `WHERE i.islemArac = 'Acenta Tahsilat'`;
          break;
        case 'depozito':
          whereCondition = `WHERE (i.islemBilgi LIKE '%=DEPOZƒ∞TO TAHSƒ∞LATI=%' OR i.islemBilgi LIKE '%=DEPOZƒ∞TO ƒ∞ADESƒ∞=%')`;
          break;
        default:
          whereCondition = `WHERE i.islemArac = 'Cari ƒ∞≈ülem'`;
      }

      // ƒ∞≈ülem y√∂n√ºne g√∂re dinamik sorgu
      let gelirCondition = '';
      let giderCondition = '';

      if (islemYonu === 'gelir-gider') {
        gelirCondition = "i.islemTip = 'GELƒ∞R'";
        giderCondition = "i.islemTip = 'Gƒ∞DER'";
      } else {
        gelirCondition = "i.islemTip = 'Giren'";
        giderCondition = "i.islemTip = '√áƒ±kan'";
      }

      const bakiyeQuery = `
        SELECT 
          SUM(CASE WHEN ${gelirCondition} THEN i.islemTutar ELSE 0 END) as toplamGelir,
          SUM(CASE WHEN ${giderCondition} THEN i.islemTutar ELSE 0 END) as toplamGider
        FROM ${schemaName}.${tableName} i
        ${whereCondition}
      `;

      const bakiyeUnknown = (await this.dataSource.query(
        bakiyeQuery,
      )) as unknown;
      const bakiyeRes = bakiyeUnknown as Array<{
        toplamGelir: number | string | null;
        toplamGider: number | string | null;
      }>;
      const toplamGelir = Number(bakiyeRes[0]?.toplamGelir) || 0;
      const toplamGider = Number(bakiyeRes[0]?.toplamGider) || 0;
      const guncelBakiye = toplamGelir - toplamGider;

      this.debugLog(`üí∞ G√ºncel bakiye hesaplandƒ± (${islemTuru}):`, {
        toplamGelir,
        toplamGider,
        guncelBakiye,
      });

      return guncelBakiye;
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('‚ùå G√ºncel bakiye hesaplama hatasƒ±:', message);
      return 0;
    }
  }

  /**
   * Se√ßilen g√ºne kadar olan bakiye hesaplar
   */
  async getSecilenGunBakiyesi(
    islemTuru: string,
    islemYonu: string,
    secilenTarih: string,
  ): Promise<number> {
    try {
      const schemaName = this.dbConfig.getTableSchema();
      const tableName = this.dbConfig.getTableName('tblislem');

      let whereCondition = '';

      // ƒ∞≈ülem t√ºr√ºne g√∂re filtreleme
      switch (islemTuru) {
        case 'cari':
          whereCondition = `WHERE i.islemArac = 'Cari ƒ∞≈ülem'`;
          break;
        case 'nakit':
          whereCondition = `WHERE i.islemArac = 'Nakit Kasa(TL)'`;
          break;
        case 'kart':
          whereCondition = `WHERE i.islemArac = 'Kredi Kartlarƒ±'`;
          break;
        case 'eft':
          whereCondition = `WHERE i.islemArac = 'Banka EFT'`;
          break;
        case 'acenta':
          whereCondition = `WHERE i.islemArac = 'Acenta Tahsilat'`;
          break;
        case 'depozito':
          whereCondition = `WHERE (i.islemBilgi LIKE '%=DEPOZƒ∞TO TAHSƒ∞LATI=%' OR i.islemBilgi LIKE '%=DEPOZƒ∞TO ƒ∞ADESƒ∞=%')`;
          break;
        default:
          whereCondition = `WHERE i.islemArac = 'Cari ƒ∞≈ülem'`;
      }

      // ƒ∞≈ülem y√∂n√ºne g√∂re dinamik sorgu
      let gelirCondition = '';
      let giderCondition = '';

      if (islemYonu === 'gelir-gider') {
        gelirCondition = "i.islemTip = 'GELƒ∞R'";
        giderCondition = "i.islemTip = 'Gƒ∞DER'";
      } else {
        gelirCondition = "i.islemTip = 'Giren'";
        giderCondition = "i.islemTip = '√áƒ±kan'";
      }

      const bakiyeQuery = `
        SELECT 
          SUM(CASE WHEN ${gelirCondition} THEN i.islemTutar ELSE 0 END) as toplamGelir,
          SUM(CASE WHEN ${giderCondition} THEN i.islemTutar ELSE 0 END) as toplamGider
        FROM ${schemaName}.${tableName} i
        ${whereCondition}
        AND CONVERT(DATE, i.iKytTarihi, 104) <= CONVERT(DATE, @0, 104)
      `;

      const secilenUnknown = (await this.dataSource.query(bakiyeQuery, [
        secilenTarih,
      ])) as unknown;
      const secilenRes = secilenUnknown as Array<{
        toplamGelir: number | string | null;
        toplamGider: number | string | null;
      }>;
      const toplamGelir = Number(secilenRes[0]?.toplamGelir) || 0;
      const toplamGider = Number(secilenRes[0]?.toplamGider) || 0;
      const secilenGunBakiyesi = toplamGelir - toplamGider;

      this.debugLog(
        `üí∞ Se√ßilen g√ºn bakiyesi hesaplandƒ± (${islemTuru}, ${secilenTarih}):`,
        {
          toplamGelir,
          toplamGider,
          secilenGunBakiyesi,
        },
      );

      return secilenGunBakiyesi;
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('‚ùå Se√ßilen g√ºn bakiyesi hesaplama hatasƒ±:', message);
      return 0;
    }
  }

  /**
   * tblKasaDevir tablosundan sayfalanmƒ±≈ü verileri getirir
   */
  async getKasaDevirVerileri(
    page: number = 1,
    rowsPerPage: number = 3,
  ): Promise<{ data: KasaDevirKaydi[]; totalRecords: number }> {
    try {
      const offset = (page - 1) * rowsPerPage;

      // Toplam kayƒ±t sayƒ±sƒ±nƒ± al
      const countQuery = `
        SELECT COUNT(*) as total
        FROM ${this.dbConfig.getTableSchema()}.tblKasaDevir
      `;

      const countDevirUnknown = (await this.dataSource.query(
        countQuery,
      )) as unknown;
      const countDevir = countDevirUnknown as Array<{ total: number }>;
      const totalRecords = Number(countDevir[0]?.total || 0);

      // Sayfalanmƒ±≈ü verileri al
      const query = `
        SELECT 
          kd.nKytTarihi as DevirTarihi,
          kd.nKasaDvrAln as DevirEden,
          kd.nKasaYekun as KasaYekun
        FROM ${this.dbConfig.getTableSchema()}.tblKasaDevir kd
        ORDER BY CONVERT(DATE, kd.nKytTarihi, 104) DESC
        OFFSET ${offset} ROWS
        FETCH NEXT ${rowsPerPage} ROWS ONLY
      `;

      const devirUnknown = (await this.dataSource.query(query)) as unknown;
      const result = devirUnknown as Array<{
        DevirTarihi: string;
        DevirEden: string;
        KasaYekun: number | string;
      }>;
      this.debugLog(
        'üìä Kasa devir verileri alƒ±ndƒ±:',
        result.length,
        'kayƒ±t (sayfa:',
        page,
        ')',
      );

      const typed: KasaDevirKaydi[] = (
        result as Array<{
          DevirTarihi: string;
          DevirEden: string;
          KasaYekun: number | string;
        }>
      ).map((row) => ({
        DevirTarihi: row.DevirTarihi,
        DevirEden: row.DevirEden,
        KasaYekun: Number(row.KasaYekun) || 0,
      }));

      return {
        data: typed,
        totalRecords: totalRecords,
      };
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('‚ùå Kasa devir verileri alma hatasƒ±:', message);
      return {
        data: [],
        totalRecords: 0,
      };
    }
  }

  /**
   * Aktif kullanƒ±cƒ±nƒ±n PrsnUsrNm bilgisini tblPersonel tablosundan alƒ±r
   */
  private async getAktifKullaniciAdi(): Promise<string> {
    try {
      // ≈ûimdilik varsayƒ±lan kullanƒ±cƒ± olarak SAadmin kullanƒ±yoruz
      // TODO: Ger√ßek authentication sistemi entegre edildiƒüinde bu kƒ±sƒ±m g√ºncellenecek
      const query = `
        SELECT TOP 1 PrsnUsrNm 
        FROM ${this.dbConfig.getTableSchema()}.tblPersonel 
        WHERE PrsnUsrNm = 'SAadmin'
      `;

      const userUnknown = (await this.dataSource.query(query)) as unknown;
      const result = userUnknown as Array<{ PrsnUsrNm: string }>;
      const kullaniciAdi = result[0]?.PrsnUsrNm ?? 'SAadmin';

      this.debugLog('üë§ Aktif kullanƒ±cƒ± bilgisi alƒ±ndƒ±:', kullaniciAdi);
      return kullaniciAdi;
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('‚ùå Kullanƒ±cƒ± bilgisi alma hatasƒ±:', message);
      return 'SAadmin'; // Fallback deƒüer
    }
  }

  /**
   * Kasalar arasƒ± aktarƒ±m i≈ülemi - islemEKLE stored procedure kullanarak
   */
  async kasaAktarimi(veren: string, alan: string, tutar: number): Promise<any> {
    try {
      this.debugLog('üîÑ Kasa aktarƒ±mƒ± ba≈ülatƒ±lƒ±yor:', { veren, alan, tutar });

      // Bug√ºn√ºn tarihini DD.MM.YYYY formatƒ±nda al
      const bugun = new Date();
      const iKytTarihi =
        bugun.getDate().toString().padStart(2, '0') +
        '.' +
        (bugun.getMonth() + 1).toString().padStart(2, '0') +
        '.' +
        bugun.getFullYear();

      // Kasa parametrelerini belirle
      const kasaParametreleri = {
        nakit: {
          islemCrKod: 'PN10000',
          islemArac: 'Nakit Kasa(TL)',
          islemAltG: 'PANSƒ∞YON NAKƒ∞T Gƒ∞DERLERƒ∞',
        },
        kart: {
          islemCrKod: 'PK10000',
          islemArac: 'Kredi Kartlarƒ±',
          islemAltG: 'PANSƒ∞YON KREDƒ∞ KARTI Gƒ∞DERLERƒ∞',
        },
        eft: {
          islemCrKod: 'PB10000',
          islemArac: 'Banka EFT',
          islemAltG: 'PANSƒ∞YON BANKA Gƒ∞DERLERƒ∞',
        },
        acenta: {
          islemCrKod: 'PA10000',
          islemArac: 'Acenta Tahsilat',
          islemAltG: 'PANSƒ∞YON ACENTA KASASI',
        },
        depozito: {
          islemCrKod: 'PD10000',
          islemArac: 'Depozito Kasasƒ±',
          islemAltG: 'PANSƒ∞YON DEPOZƒ∞TO KASASI',
        },
      };

      const verenParametreleri = kasaParametreleri[veren];
      const alanParametreleri = kasaParametreleri[alan];

      if (!verenParametreleri || !alanParametreleri) {
        throw new Error('Ge√ßersiz kasa t√ºr√º se√ßildi');
      }

      // Aktif kullanƒ±cƒ± bilgisini al
      const islemKllnc = await this.getAktifKullaniciAdi();

      // Transaction ba≈ülat
      const queryRunner = this.dataSource.createQueryRunner();
      await queryRunner.connect();
      await queryRunner.startTransaction();

      try {
        // 1. Veren kasadan √ßƒ±kƒ±≈ü i≈ülemi
        const verenIslemQuery = `
          EXEC ${this.dbConfig.getSpName('spr_islemEkleYn')} 
            @iKytTarihi = @0,
            @islemKllnc = @1,
            @islemCrKod = @2,
            @islemOzel1 = @3,
            @islemOzel2 = @4,
            @islemOzel3 = @5,
            @islemOzel4 = @6,
            @islemArac = @7,
            @islemTip = @8,
            @islemGrup = @9,
            @islemAltG = @10,
            @islemBilgi = @11,
            @islemMiktar = @12,
            @islemBirim = @13,
            @islemTutar = @14,
            @islemDoviz = @15,
            @islemKur = @16
        `;

        const verenIslemParams = [
          iKytTarihi, // @0 iKytTarihi
          islemKllnc, // @1 islemKllnc
          verenParametreleri.islemCrKod, // @2 islemCrKod
          '', // @3 islemOzel1
          '', // @4 islemOzel2
          '', // @5 islemOzel3
          '', // @6 islemOzel4
          verenParametreleri.islemArac, // @7 islemArac
          '√áƒ±kan', // @8 islemTip
          'Kasaya Verilen', // @9 islemGrup
          verenParametreleri.islemAltG, // @10 islemAltG
          `${verenParametreleri.islemArac} Kasasƒ±na Verilen Tutar`, // @11 islemBilgi
          1, // @12 islemMiktar
          'ADET', // @13 islemBirim
          tutar, // @14 islemTutar
          'TL', // @15 islemDoviz
          1, // @16 islemKur
        ];

        this.debugLog('üì§ Veren kasadan √ßƒ±kƒ±≈ü i≈ülemi ger√ßekle≈ütiriliyor...');
        await queryRunner.query(verenIslemQuery, verenIslemParams);
        this.debugLog('‚úÖ Veren kasadan √ßƒ±kƒ±≈ü i≈ülemi kaydedildi');

        // 2. Alan kasaya giri≈ü i≈ülemi
        const alanIslemParams = [
          iKytTarihi, // @0 iKytTarihi
          islemKllnc, // @1 islemKllnc
          alanParametreleri.islemCrKod, // @2 islemCrKod
          '', // @3 islemOzel1
          '', // @4 islemOzel2
          '', // @5 islemOzel3
          '', // @6 islemOzel4
          alanParametreleri.islemArac, // @7 islemArac
          'Giren', // @8 islemTip
          'Kasadan Alƒ±nan', // @9 islemGrup
          alanParametreleri.islemAltG, // @10 islemAltG
          `${alanParametreleri.islemArac} Kasasƒ±ndan Alƒ±nan Tutar`, // @11 islemBilgi
          1, // @12 islemMiktar
          'ADET', // @13 islemBirim
          tutar, // @14 islemTutar
          'TL', // @15 islemDoviz
          1, // @16 islemKur
        ];

        this.debugLog('üì• Alan kasaya giri≈ü i≈ülemi ger√ßekle≈ütiriliyor...');
        await queryRunner.query(verenIslemQuery, alanIslemParams);
        this.debugLog('‚úÖ Alan kasaya giri≈ü i≈ülemi kaydedildi');

        // Transaction'ƒ± commit et
        await queryRunner.commitTransaction();

        const basariliMesaj = `‚úÖ Kasa aktarƒ±mƒ± ba≈üarƒ±yla tamamlandƒ±!\n\nüí∞ ${verenParametreleri.islemArac} ‚Üí ${alanParametreleri.islemArac}\nüíµ Tutar: ${tutar.toLocaleString('tr-TR')} TL\nüë§ ƒ∞≈ülemi Yapan: ${islemKllnc}\nüìÖ Tarih: ${iKytTarihi}`;

        this.debugLog('‚úÖ Kasa aktarƒ±mƒ± ba≈üarƒ±yla tamamlandƒ±');

        return {
          success: true,
          message: basariliMesaj,
          details: {
            veren: verenParametreleri.islemArac,
            alan: alanParametreleri.islemArac,
            tutar: tutar,
            kullanici: islemKllnc,
            tarih: iKytTarihi,
          },
        };
      } catch (error) {
        // Hata durumunda rollback
        await queryRunner.rollbackTransaction();

        const hataMesaj = `‚ùå Kasa aktarƒ±mƒ± ba≈üarƒ±sƒ±z!\n\nüîç Hata Detayƒ±: ${error.message}\nüí∞ ƒ∞≈ülem: ${verenParametreleri.islemArac} ‚Üí ${alanParametreleri.islemArac}\nüíµ Tutar: ${tutar.toLocaleString('tr-TR')} TL\nüìÖ Tarih: ${iKytTarihi}`;

        console.error('‚ùå Kasa aktarƒ±mƒ± hatasƒ±, rollback yapƒ±ldƒ±:', error);
        throw new Error(hataMesaj);
      } finally {
        // Query runner'ƒ± serbest bƒ±rak
        await queryRunner.release();
        this.debugLog('üîí Transaction kaynaklarƒ± serbest bƒ±rakƒ±ldƒ±');
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : String(error);
      console.error('‚ùå Kasa aktarƒ±mƒ± genel hatasƒ±:', message);
      throw error; // Zaten formatlanmƒ±≈ü hata mesajƒ±nƒ± tekrar formatlamaya gerek yok
    }
  }
}
