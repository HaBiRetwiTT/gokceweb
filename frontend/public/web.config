<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <!-- Püf Nokta: Reverse proxy kuralı SPA Routes kuralından ÖNCE gelmelidir -->
        <!-- Çünkü stopProcessing="true" olduğunda sonraki kurallar işlenmez -->
        <!-- API isteklerini backend'e yönlendir (localhost:3000) -->
        <!-- Püf Nokta: IIS Application Request Routing (ARR) modülü gereklidir -->
        <!-- ARR yüklü değilse: Web Platform Installer'dan yükleyin -->
        <!-- Püf Nokta: serverVariables kullanımı IIS'te özel izin gerektirir ve sorun çıkarabilir -->
        <!-- Bu yüzden serverVariables olmadan basit bir reverse proxy kuralı kullanıyoruz -->
        <!-- Bu VPS'te sorunsuz çalışır -->
        <!-- Püf Nokta: IIS URL Rewrite'da {R:1} kullanıldığında URL decode edilmiş olarak gelir -->
        <!-- Bu bazı senaryolarda %2B gibi encoded karakterlerin bozulmasına neden olabilir -->
        <!-- Çözüm: {UNENCODED_URL} kullanarak URL'yi raw/encoded haliyle alıp /api/ prefix'ini kaldırıyoruz -->
        <rule name="API Reverse Proxy" stopProcessing="true">
          <match url="^api/(.*)" />
          <conditions>
            <!-- {UNENCODED_URL} ile encoded karakterleri koruyoruz (örn: %2B) -->
            <add input="{UNENCODED_URL}" pattern="^/api/(.*)" />
          </conditions>
          <!-- Püf Nokta: {C:1} ile capture edilen grup kullanılır -->
          <!-- Bu grup encode edilmiş karakterleri korur -->
          <action type="Rewrite" url="http://localhost:3000/{C:1}" appendQueryString="true" />
        </rule>
        <!-- SPA Routes: Tüm istekleri index.html'e yönlendir (API hariç) -->
        <rule name="SPA Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/(api)" negate="true" />
          </conditions>
          <action type="Rewrite" url="/index.html" />
        </rule>
      </rules>
    </rewrite>
    <!-- Güvenlik Başlıkları -->
    <!-- Püf Nokta: Bu başlıklar tarayıcıya güvenlik politikaları hakkında bilgi verir -->
    <httpProtocol>
      <customHeaders>
        <!-- X-Content-Type-Options: Tarayıcının MIME type sniffing yapmasını engeller -->
        <!-- Püf Nokta: Bu, kötü amaçlı dosyaların yanlış MIME type ile çalıştırılmasını önler -->
        <add name="X-Content-Type-Options" value="nosniff" />
        
        <!-- X-Frame-Options: Clickjacking saldırılarını önler -->
        <!-- Püf Nokta: Sitenizin iframe içinde gösterilmesini engeller -->
        <add name="X-Frame-Options" value="DENY" />
        
        <!-- X-XSS-Protection: Tarayıcının XSS filtrelemesini etkinleştirir -->
        <!-- Püf Nokta: Eski tarayıcılar için ekstra koruma sağlar -->
        <add name="X-XSS-Protection" value="1; mode=block" />
        
        <!-- Referrer-Policy: Referrer bilgisinin nasıl gönderileceğini kontrol eder -->
        <!-- Püf Nokta: Hassas bilgilerin referrer üzerinden sızmasını önler -->
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
        
        <!-- Strict-Transport-Security: HTTPS zorunluluğu (SSL aktif olduğunda kullanılacak) -->
        <!-- Püf Nokta: SSL sertifikası yüklendikten sonra bu satırın yorumunu kaldırın -->
        <!-- <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" /> -->
      </customHeaders>
    </httpProtocol>
    <!-- .json için mimeMap zaten IIS'te tanımlı, tekrar eklemeye gerek yok -->
  </system.webServer>
</configuration>

