<template>
  <q-dialog v-model="show" persistent>
    <q-card 
      ref="modalCard"
      style="min-width: 350px; max-width: 420px;" 
      class="personel-tahakkuk-modal draggable-modal"
    >
      <q-card-section class="modal-header" style="cursor: move;">
        <div class="modal-title-section">
          <div class="modal-title-left">
            <span class="modal-title">
              <q-icon name="people" class="q-mr-sm" />
              Personel Tahakkuk / √ñdeme ƒ∞≈ülemleri
            </span>
          </div>
          <div class="modal-title-right">
            <span v-if="selectedPersonelNo" class="personel-no">{{ selectedPersonelNo }}</span>
          </div>
        </div>
      </q-card-section>

      <q-card-section class="q-pt-md modal-body">
        <div class="row q-col-gutter-md">
          <div class="col-12">
            <div class="row q-col-gutter-sm">
              <div class="col-12">
                <q-select
                  v-model="selectedPersonel"
                  :options="personelOptions"
                  option-label="label"
                  option-value="value"
                  label="Personel Se√ßiniz"
                  outlined
                  dense
                  clearable
                  use-input
                  hide-selected
                  fill-input
                  input-debounce="300"
                  @filter="filterPersonel"
                  :loading="loadingPersonel"
                  emit-value
                  map-options
                >
                  <template v-slot:no-option>
                    <q-item>
                      <q-item-section class="text-grey">
                        Sonu√ß bulunamadƒ±
                      </q-item-section>
                    </q-item>
                  </template>
                  
                  <template v-slot:option="scope">
                    <q-item v-bind="scope.itemProps">
                      <q-item-section>
                        <q-item-label>{{ scope.opt.label }}</q-item-label>
                      </q-item-section>
                    </q-item>
                  </template>
                </q-select>
              </div>
              
              <div class="col-12">
                <q-select
                  v-model="selectedIslemTipi"
                  :options="islemTipiOptions"
                  label="ƒ∞≈ülem Tipi Se√ßiniz"
                  outlined
                  dense
                  clearable
                  emit-value
                  map-options
                />
              </div>
              
              <div class="col-12 col-sm-6">
                <q-select
                  v-model="selectedOdemeYontemi"
                  :options="odemeYontemiOptions"
                  label="√ñdeme Y√∂ntemi..."
                  outlined
                  dense
                  clearable
                  emit-value
                  map-options
                  :readonly="isOdemeYontemiReadonly"
                />
              </div>
              
              <div class="col-12 col-sm-6">
                <q-input
                  v-model.number="effectiveIslemTutar"
                  label="ƒ∞≈ülem Tutarƒ±"
                  outlined
                  dense
                  type="number"
                  step="1"
                  min="0"
                  suffix="TL"
                  :readonly="isIslemTutarReadonly"
                  :rules="[val => val > 0 || 'Tutar 0\'dan b√ºy√ºk olmalƒ±dƒ±r']"
                />
              </div>
            </div>
          </div>
        </div>
      </q-card-section>

      <q-card-actions align="right" class="modal-actions">
        <div class="row full-width items-center justify-between">
          <div class="col-auto">
            <!-- Personel bakiye bilgisi -->
            <div v-if="selectedPersonel" class="personel-bakiye-info">
              <span class="bakiye-label">Bakiye: </span>
              <span v-if="loadingBakiye" class="bakiye-loading">
                <q-spinner size="12px" />
              </span>
              <span v-else class="bakiye-tutar" :class="{ 
                'bakiye-pozitif': personelBakiye && personelBakiye > 0,
                'bakiye-negatif': personelBakiye && personelBakiye < 0,
                'bakiye-sifir': personelBakiye === 0
              }">
                {{ personelBakiye !== null ? personelBakiye.toLocaleString('tr-TR', { 
                  style: 'currency', 
                  currency: 'TRY',
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                }) : '0,00 ‚Ç∫' }}
              </span>
            </div>
          </div>
          <div class="col-auto">
            <q-btn
              label="KAYDET"
              color="primary"
              @click="onKaydet"
              :disable="!selectedPersonel || !selectedIslemTipi || (!selectedOdemeYontemi && !isOdemeYontemiReadonly) || !effectiveIslemTutar || effectiveIslemTutar <= 0"
              class="q-mr-sm"
            />
            <q-btn
              label="KAPAT"
              color="secondary"
              @click="onKapat"
            />
          </div>
        </div>
      </q-card-actions>
    </q-card>
  </q-dialog>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch, nextTick } from 'vue'
import { useQuasar } from 'quasar'
import { api } from '../boot/axios'

// Props
interface Props {
  modelValue: boolean
}

const props = defineProps<Props>()

// Emits
const emit = defineEmits<{
  'update:modelValue': [value: boolean]
  'kaydet': [data: { 
    personel: string
    islemTipi: string
    odemeYontemi: string
    tutar: number
    result?: {
      personel: string
      islemTipi: string
      tutar: number
      tarih: string
    }
  }]
}>()

// Quasar instance
const $q = useQuasar()

// Reactive data
const loadingPersonel = ref(false)
const selectedPersonel = ref<string | null>(null)
const selectedPersonelNo = ref<number | null>(null)
const selectedIslemTipi = ref<string | null>(null)
const selectedOdemeYontemi = ref<string | null>(null)
const islemTutar = ref<number>(0)
const personelList = ref<Array<{ PrsnAdi: string, PrsnNo: number }>>([])
const filteredPersonelList = ref<Array<{ PrsnAdi: string, PrsnNo: number }>>([])  
const modalCard = ref()
const personelBakiye = ref<number | null>(null)
const loadingBakiye = ref(false)

// Computed
const show = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value)
})

const personelOptions = computed(() => {
  return filteredPersonelList.value.map(personel => ({
    label: personel.PrsnAdi,
    value: personel.PrsnAdi
  })).sort((a, b) => a.label.localeCompare(b.label, 'tr', { sensitivity: 'base' }))
})

const islemTipiOptions = computed(() => [
  { label: 'Maa≈ü Tahakkuk', value: 'maas_tahakkuk' },
  { label: 'ƒ∞kramiye Tahakkuk', value: 'ikramiye_tahakkuk' },
  { label: 'Maa≈ü √ñdemesi', value: 'maas_odeme' },
  { label: 'ƒ∞kramiye √ñdemesi', value: 'ikramiye_odeme' },
  { label: 'Avans √ñdemesi', value: 'avans_odeme' },
  { label: 'Bor√ß Verme', value: 'borc_verme' },
  { label: 'Bor√ß ƒ∞adesi', value: 'borc_iade' },
  { label: '√áƒ±kƒ±≈ü Hesap Kapama', value: 'cikis_hesap_kapama' }
])

const odemeYontemiOptions = computed(() => [
  { label: 'Nakit Kasa(TL)', value: 'nakit_kasa' },
  { label: 'Banka EFT', value: 'banka_eft' }
])

const isOdemeYontemiReadonly = computed(() => {
  return selectedIslemTipi.value === 'maas_tahakkuk' || selectedIslemTipi.value === 'ikramiye_tahakkuk'
})

const isCikisHesapKapama = computed(() => {
  return selectedIslemTipi.value === 'cikis_hesap_kapama'
})

const isIslemTutarReadonly = computed(() => {
  return isCikisHesapKapama.value
})

const effectiveIslemTutar = computed({
  get: () => {
    if (isCikisHesapKapama.value && personelBakiye.value !== null) {
      return Math.abs(personelBakiye.value)
    }
    return islemTutar.value
  },
  set: (value) => {
    if (!isCikisHesapKapama.value) {
      islemTutar.value = value
    }
  }
})

// ƒ∞≈ülem tipi label'ƒ±nƒ± almak i√ßin computed property
const selectedIslemTipiLabel = computed(() => {
  if (!selectedIslemTipi.value) return null
  const foundOption = islemTipiOptions.value.find(option => option.value === selectedIslemTipi.value)
  return foundOption?.label || null
})

// Methods
async function loadPersonelBakiye(personelNo: number) {
  try {
    loadingBakiye.value = true
    console.log('üí∞ Personel bakiyesi y√ºkl√ºyor, Personel No:', personelNo)
    
    const response = await api.get(`/personel/bakiye/${personelNo}`)
    
    if (response.data.success) {
      personelBakiye.value = response.data.bakiye
      console.log('‚ú® Personel bakiyesi y√ºklendi:', personelBakiye.value)
    } else {
      throw new Error(response.data.message || 'Personel bakiyesi y√ºklenemedi')
    }
  } catch (error: unknown) {
    console.error('‚ùå Personel bakiyesi y√ºkleme hatasƒ±:', error)
    personelBakiye.value = 0
    
    // Kullanƒ±cƒ±ya hata bildirimi g√∂sterme (sessiz hata)
    // $q.notify({
    //   type: 'warning',
    //   message: 'Personel bakiyesi y√ºklenemedi',
    //   position: 'top'
    // })
  } finally {
    loadingBakiye.value = false
  }
}

async function loadPersonelList() {
  try {
    loadingPersonel.value = true
    console.log('üîç Aktif personel listesi y√ºkleniyor...')
    
    const response = await api.get('/personel/calisanlar')
    
    if (response.data.success) {
      personelList.value = response.data.data
      filteredPersonelList.value = response.data.data
      console.log('‚úÖ Aktif personel listesi y√ºklendi:', personelList.value.length, 'kayƒ±t')
    } else {
      throw new Error(response.data.message || 'Personel listesi y√ºklenemedi')
    }
  } catch (error: unknown) {
    console.error('‚ùå Personel listesi y√ºkleme hatasƒ±:', error)
    let errorMessage = 'Personel listesi y√ºklenirken hata olu≈ütu'
    
    if (error && typeof error === 'object' && 'response' in error) {
      const apiError = error as { response?: { data?: { message?: string } } }
      if (apiError.response?.data?.message) {
        errorMessage = apiError.response.data.message
      }
    }
    
    $q.notify({
      type: 'negative',
      message: errorMessage,
      position: 'top'
    })
  } finally {
    loadingPersonel.value = false
  }
}

function filterPersonel(val: string, update: (callback: () => void) => void) {
  update(() => {
    if (val === '') {
      filteredPersonelList.value = personelList.value
    } else {
      const needle = val.toLowerCase()
      filteredPersonelList.value = personelList.value.filter(personel => 
        personel.PrsnAdi.toLowerCase().indexOf(needle) > -1
      )
    }
  })
}

async function onKaydet() {
  if (!selectedPersonel.value) {
    $q.notify({
      type: 'warning',
      message: 'L√ºtfen bir personel se√ßiniz',
      position: 'top'
    })
    return
  }

  if (!selectedIslemTipi.value) {
    $q.notify({
      type: 'warning',
      message: 'L√ºtfen bir i≈ülem tipi se√ßiniz',
      position: 'top'
    })
    return
  }

  // √áƒ±kƒ±≈ü Hesap Kapama i√ßin √∂zel kontrol
  if (isCikisHesapKapama.value) {
    if (personelBakiye.value === 0) {
      $q.notify({
        type: 'warning',
        message: 'Personel Cari Bakiyesi YOK!',
        position: 'top'
      })
      // Form'u kapat
      emit('update:modelValue', false)
      return
    }
  }

  if (!selectedOdemeYontemi.value && !isOdemeYontemiReadonly.value) {
    $q.notify({
      type: 'warning',
      message: 'L√ºtfen bir √∂deme y√∂ntemi se√ßiniz',
      position: 'top'
    })
    return
  }

  if (!effectiveIslemTutar.value || effectiveIslemTutar.value <= 0) {
    $q.notify({
      type: 'warning',
      message: 'L√ºtfen ge√ßerli bir tutar giriniz',
      position: 'top'
    })
    return
  }

  try {
    console.log('üöÄ Personel tahakkuk/√∂deme kaydƒ± ba≈ülatƒ±lƒ±yor...')
    
    // Loading state'i g√∂ster
    loadingPersonel.value = true
    
    // ƒ∞≈ülem tipini belirle (√áƒ±kƒ±≈ü Hesap Kapama i√ßin √∂zel logic)
    let finalIslemTipi = selectedIslemTipi.value
    let islemGrup = undefined
    
    if (isCikisHesapKapama.value && personelBakiye.value !== null) {
      console.log('üîç √áƒ±kƒ±≈ü Hesap Kapama logic:', {
        isCikisHesapKapama: isCikisHesapKapama.value,
        personelBakiye: personelBakiye.value,
        originalIslemTipi: selectedIslemTipi.value
      })
      
      // √áƒ±kƒ±≈ü Hesap Kapama i√ßin, backend'in √∂deme i≈ülemi olarak tanƒ±masƒ± i√ßin
      // islemTipi'ni deƒüi≈ütiriyoruz ve islemGrup ekliyoruz
      if (personelBakiye.value < 0) {
        // Personel bor√ß vermi≈ü (negatif bakiye) - personelden √ßƒ±kan
        finalIslemTipi = 'cikis_hesap_kapama_cikan'
      } else {
        // Personele bor√ßluyuz (pozitif bakiye) - personele giren
        finalIslemTipi = 'cikis_hesap_kapama_giren'
      }
      
      islemGrup = '√áƒ±kƒ±≈ü Hesap Kapama'
      
      console.log('üìã Belirlenen final i≈ülem tipi:', {
        condition: personelBakiye.value < 0 ? 'bakiye < 0 (personelden √ßƒ±kan)' : 'bakiye >= 0 (personele giren)',
        finalIslemTipi: finalIslemTipi,
        islemGrup: islemGrup
      })
    }
    
    // Backend'e g√∂nderilecek veriyi hazƒ±rla
    const requestData = {
      personel: selectedPersonel.value,
      islemTipi: finalIslemTipi,
      odemeYontemi: selectedOdemeYontemi.value || 'tahakkuk',
      tutar: effectiveIslemTutar.value,
      islemBilgi: selectedIslemTipiLabel.value, // Daima i≈ülem tipi label bilgisini g√∂nder
      ...(islemGrup && { islemGrup: islemGrup })
    }
    
    console.log('üìù G√∂nderilecek veri:', requestData)
    
    // Backend API'sine istek g√∂nder
    const response = await api.post('/personel/tahakkuk-odeme', requestData)
    
    if (response.data.success) {
      // Ba≈üarƒ± mesajƒ± g√∂ster
      $q.notify({
        type: 'positive',
        message: response.data.message || 'Personel tahakkuk/√∂deme kaydƒ± ba≈üarƒ±yla olu≈üturuldu',
        position: 'top',
        timeout: 4000
      })
      
      // Parent component'e bildiri g√∂nder
      emit('kaydet', {
        personel: selectedPersonel.value,
        islemTipi: finalIslemTipi,
        odemeYontemi: selectedOdemeYontemi.value || 'tahakkuk',
        tutar: effectiveIslemTutar.value,
        result: response.data.data
      })
      
      // Modal'i kapat
      emit('update:modelValue', false)
      
      console.log('‚úÖ Personel tahakkuk/√∂deme kaydƒ± ba≈üarƒ±yla tamamlandƒ±')
      
    } else {
      throw new Error(response.data.message || 'Kayƒ±t i≈ülemi ba≈üarƒ±sƒ±z')
    }
    
  } catch (error: unknown) {
    console.error('‚ùå Personel tahakkuk/√∂deme kaydetme hatasƒ±:', error)
    
    let errorMessage = 'Personel tahakkuk/√∂deme kaydƒ± sƒ±rasƒ±nda hata olu≈ütu'
    
    if (error && typeof error === 'object' && 'response' in error) {
      const apiError = error as { response?: { data?: { message?: string } } }
      if (apiError.response?.data?.message) {
        errorMessage = apiError.response.data.message
      }
    } else if (error instanceof Error) {
      errorMessage = error.message
    }
    
    $q.notify({
      type: 'negative',
      message: errorMessage,
      position: 'top',
      timeout: 5000
    })
    
  } finally {
    loadingPersonel.value = false
  }
}

function onKapat() {
  // Reset form
  selectedPersonel.value = null
  selectedPersonelNo.value = null
  selectedIslemTipi.value = null
  selectedOdemeYontemi.value = null
  islemTutar.value = 0
  personelBakiye.value = null
  // Close modal
  emit('update:modelValue', false)
}

// Watch for modal visibility changes
watch(() => props.modelValue, async (newValue) => {
  if (newValue) {
    // Modal opened, load personnel list
    loadPersonelList().catch((error) => {
      console.error('Error loading personnel list in watch:', error)
    })
    
    // Initialize draggable after DOM is ready
    await nextTick()
    initializeDraggable()
  } else {
    // Modal closed, reset form
    selectedPersonel.value = null
    selectedPersonelNo.value = null
    selectedIslemTipi.value = null
    selectedOdemeYontemi.value = null
    islemTutar.value = 0
    personelBakiye.value = null
  }
})

// Watch for personnel selection to update personnel number and load balance
watch(() => selectedPersonel.value, async (newPersonel) => {
  if (newPersonel) {
    const foundPersonel = personelList.value.find(p => p.PrsnAdi === newPersonel)
    selectedPersonelNo.value = foundPersonel?.PrsnNo || null
    
    // Load personnel balance using personnel number
    if (foundPersonel?.PrsnNo) {
      await loadPersonelBakiye(foundPersonel.PrsnNo)
    }
  } else {
    selectedPersonelNo.value = null
    personelBakiye.value = null
  }
})

// Watch for transaction type changes to clear payment method when readonly
watch(() => selectedIslemTipi.value, (newValue) => {
  if (newValue === 'maas_tahakkuk' || newValue === 'ikramiye_tahakkuk') {
    // Clear payment method when it becomes readonly
    selectedOdemeYontemi.value = null
  }
  
  // √áƒ±kƒ±≈ü Hesap Kapama se√ßildiƒüinde tutarƒ± otomatik doldur
  if (newValue === 'cikis_hesap_kapama' && personelBakiye.value !== null) {
    // Tutar otomatik olarak computed property ile doldurulacak
    console.log('üîÑ √áƒ±kƒ±≈ü Hesap Kapama se√ßildi, tutar otomatik dolduruldu:', Math.abs(personelBakiye.value))
  }
})

// Load personnel list on component mount
onMounted(async () => {
  if (props.modelValue) {
    loadPersonelList().catch((error) => {
      console.error('Error loading personnel list on mount:', error)
    })
    
    // Initialize draggable after DOM is ready
    await nextTick()
    initializeDraggable()
  }
})

// Draggable functionality
function initializeDraggable() {
  if (!modalCard.value) {
    console.log('Modal card ref not found')
    return
  }
  
  // Get the actual DOM element (Quasar component has $el property)
  const modal = modalCard.value.$el || modalCard.value
  const header = modal.querySelector('.modal-header')
  
  if (!header) {
    console.log('Modal header not found')
    return
  }
  
  console.log('Initializing draggable functionality')
  
  let isDragging = false
  let currentX = 0
  let currentY = 0
  let initialX = 0
  let initialY = 0
  let xOffset = 0
  let yOffset = 0
  
  // Remove existing listeners to prevent duplicates
  header.removeEventListener('mousedown', dragStart)
  document.removeEventListener('mousemove', drag)
  document.removeEventListener('mouseup', dragEnd)
  
  // Add event listeners
  header.addEventListener('mousedown', dragStart)
  document.addEventListener('mousemove', drag)
  document.addEventListener('mouseup', dragEnd)
  
  function dragStart(e: MouseEvent) {
    isDragging = true
    modal.style.position = 'fixed'
    modal.style.zIndex = '9999'
    
    initialX = e.clientX - xOffset
    initialY = e.clientY - yOffset
    
    document.body.style.userSelect = 'none'
    console.log('Drag started')
  }
  
  function drag(e: MouseEvent) {
    if (isDragging) {
      e.preventDefault()
      
      currentX = e.clientX - initialX
      currentY = e.clientY - initialY
      
      xOffset = currentX
      yOffset = currentY
      
      modal.style.transform = `translate(${currentX}px, ${currentY}px)`
    }
  }
  
  function dragEnd() {
    if (isDragging) {
      isDragging = false
      document.body.style.userSelect = ''
      console.log('Drag ended')
    }
  }
}
</script>

<style scoped>
/* Modal Form Stilleri */
.personel-tahakkuk-modal {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

/* Draggable modal stilleri */
.draggable-modal {
  user-select: none;
  transition: box-shadow 0.2s ease;
}

.draggable-modal:hover {
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
}

.modal-header {
  background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 8px 8px 0 0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: move;
  user-select: none;
}

.modal-header:hover {
  background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
}

.modal-title-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.modal-title-left {
  flex: 1;
}

.modal-title {
  font-size: 1.0rem;
  font-weight: 600;
  text-align: center;
}

.modal-title-right {
  flex: 0 0 auto;
}

.personel-no {
  font-size: 0.9rem;
  font-weight: 400;
  opacity: 0.8;
  color: rgba(255, 255, 255, 0.9);
  background: rgba(255, 255, 255, 0.1);
  padding: 4px 8px;
  border-radius: 4px;
  backdrop-filter: blur(2px);
}

/* Modal body stilleri */
.modal-body {
  padding: 24px;
  background: #f8f9fa;
}

/* Modal actions stilleri */
.modal-actions {
  background: #f8f9fa;
  border-top: 1px solid #e9ecef;
  padding: 16px 24px;
}

/* Personel bakiye bilgisi stilleri */
.personel-bakiye-info {
  display: flex;
  align-items: center;
  gap: 4px;
  background: transparent;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.9rem;
}

.bakiye-label {
  color: #666;
  font-weight: 500;
}

.bakiye-loading {
  display: flex;
  align-items: center;
}

.bakiye-tutar {
  font-weight: 600;
  transition: color 0.2s ease;
}

.bakiye-pozitif {
  color: #4caf50; /* Ye≈üil - alacaklƒ± */
}

.bakiye-negatif {
  color: #f44336; /* Kƒ±rmƒ±zƒ± - bor√ßlu */
}

.bakiye-sifir {
  color: #666; /* Gri - sƒ±fƒ±r bakiye */
}

/* Modal actions butonlarƒ± arasƒ± padding */
.modal-actions .q-btn + .q-btn {
  margin-left: 12px;
}

/* Dark mode support */
.body--dark .personel-tahakkuk-modal {
  background-color: #1e1e1e;
  color: #ffffff;
}

.body--dark .modal-header {
  background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
}

.body--dark .modal-header:hover {
  background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
}

.body--dark .modal-body {
  background: #2c3e50;
}

.body--dark .modal-actions {
  background: #34495e;
  border-top: 1px solid #495057;
}

/* Dark mode i√ßin personel bakiye bilgisi renkleri */
.body--dark .bakiye-label {
  color: #e0e0e0; /* A√ßƒ±k gri - dark mode i√ßin daha g√∂r√ºn√ºr */
}

.body--dark .bakiye-pozitif {
  color: #66bb6a; /* A√ßƒ±k ye≈üil - dark mode i√ßin daha parlak */
}

.body--dark .bakiye-negatif {
  color: #ef5350; /* A√ßƒ±k kƒ±rmƒ±zƒ± - dark mode i√ßin daha parlak */
}

.body--dark .bakiye-sifir {
  color: #bdbdbd; /* A√ßƒ±k gri - dark mode i√ßin daha g√∂r√ºn√ºr */
}

/* Modal'ƒ±n ekran sƒ±nƒ±rlarƒ±nda kalmasƒ± i√ßin */
.q-dialog {
  overflow: visible !important;
}

.q-dialog .q-card {
  position: relative !important;
  z-index: 2000 !important;
  cursor: default !important;
}

/* Modal header i√ßin daha g√º√ßl√º stil */
.modal-header * {
  pointer-events: auto !important;
}

.modal-header .q-btn {
  pointer-events: auto !important;
}

/* Responsive padding */
@media (max-width: 768px) {
  .modal-actions .q-btn + .q-btn {
    margin-left: 8px;
  }
}
</style>